# 2.0 - Refatoração da Persistência e Cálculo

## Objetivo
- Alterar o fluxo de recebimento de dados do N8N para persistir cada item individualmente na tabela normalizada, já com a data de vencimento calculada.

## Escopo / Entregáveis
- Refatoração de `src/services/similaridadeResultadoService.js`.
- Integração com utilitário de cálculo de dias úteis.

## Passos e subtarefas
- 2.1 Implementar loop de inserção individual para cada item do lote recebido.
- 2.2 Integrar `addBusinessDays` (ou similar) para calcular `data_vencimento` somando `prazo_dias` à `data_publicacao`.
- 2.3 Atualizar o status do upload para `processado` somente após a inserção bem-sucedida de todos os itens.

## Dependências
- 1.0 - Evolução do Schema (SQL).

## Paralelizável?
- Sim, com o desenvolvimento dos endpoints de conciliação (3.0).

## Critérios de aceite
- Cada item do JSON retornado pelo N8N deve gerar uma linha na tabela `similaridade_itens`.
- A coluna `data_vencimento` deve bater exatamente com a regra de dias úteis do sistema.

## Testes
- 2.4 Testar processamento de um lote com 5 itens e validar se 5 linhas foram criadas.
- 2.5 Validar cálculo de vencimento em datas com feriados conhecidos.

## Notas
- Atenção ao tratamento de erros: se um item falhar, a transação do lote deve ser avaliada (rollback ou log de erro).
